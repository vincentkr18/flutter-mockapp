name: Flutter CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:

  android:
    name: Build Android APK
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout code
      - uses: actions/checkout@v4

      # 2Ô∏è‚É£ Cache Flutter packages
      - name: Cache Flutter Pub
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            ${{ github.workspace }}/.dart_tool
          key: ${{ runner.os }}-flutter-${{ hashFiles('pubspec.yaml') }}

      # 3Ô∏è‚É£ Cache Gradle
      - name: Cache Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('android/build.gradle') }}

      # 4Ô∏è‚É£ Install Flutter
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: '3.38.6'

      # 5Ô∏è‚É£ Get dependencies
      - run: flutter pub get

      # 6Ô∏è‚É£ Run dummy test (always passes)
      - run: flutter test

      # üîê NEW: Decode Android keystore
      - name: Decode Android keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/upload-keystore.jks

      # üîê NEW: Create key.properties
      - name: Create key.properties
        run: |
          cat <<EOF > android/key.properties
          storeFile=upload-keystore.jks
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          EOF


      # 7Ô∏è‚É£ Increase Gradle memory for CI
      - run: |
          echo "org.gradle.jvmargs=-Xmx4g" >> android/gradle.properties
          echo "org.gradle.parallel=true" >> android/gradle.properties
          echo "org.gradle.configureondemand=true" >> android/gradle.properties

      # 8Ô∏è‚É£ Build APK (single ABI for speed)
      - run: flutter build apk --release --target-platform=android-arm64 --android-skip-build-dependency-validation

      # 9Ô∏è‚É£ Upload APK artifact
      - uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/app-release.apk

  ios:
    name: Build iOS IPA
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      # 1Ô∏è‚É£ Install Flutter
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: '3.38.6'

      # 2Ô∏è‚É£ Get dependencies
      - run: flutter pub get

      # 3Ô∏è‚É£ Build iOS without code signing (CI test)
      - run: flutter build ios --release --no-codesign

      # 4Ô∏è‚É£ Build IPA without code signing
      - run: flutter build ipa --no-codesign

      # 5Ô∏è‚É£ Upload IPA artifact
      - uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: build/ios/ipa
